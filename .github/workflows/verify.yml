name: Verify with Proof Systems

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  kani:
    name: Kani Verification
    runs-on: ubuntu-latest
    # Prevent auto-cancel on new pushes to the same ref while we diagnose
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false
    # Put an explicit cap so failures show as timeout rather than cancellation
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Kani
        run: |
          cargo install --locked kani-verifier
          cargo kani setup

      - name: Build crate
        run: cargo build

      - name: Kani codegen sanity (fast compile)
        run: |
          set -euxo pipefail
          date
          # Quick compile-only pass to surface build errors fast
          cargo kani --tests --harness verify_push_increments_len_binomial --only-codegen --verbose
          date

      - name: Run Kani – basic trait-level proof
        timeout-minutes: 30
        run: |
          set -euxo pipefail
          date
          cargo kani --tests --harness verify_push_increments_len_binomial --verbose
          date

      - name: Run Kani – implementation-specific proof (binomial decrease_key)
        timeout-minutes: 30
        run: |
          set -euxo pipefail
          date
          cargo kani --tests --harness verify_binomial_heap_property_after_decrease_key --verbose
          date

      - name: Run Kani – legacy simple proof
        timeout-minutes: 30
        run: |
          set -euxo pipefail
          date
          cargo kani --tests --harness verify_insert_increments_len --verbose
          date
