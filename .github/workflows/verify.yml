name: Verify with Proof Systems

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  kani:
    name: Kani Verification
    runs-on: ubuntu-latest
    # Prevent auto-cancel on new pushes to the same ref while we diagnose
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false
    # Put an explicit cap so failures show as timeout rather than cancellation
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Kani
        run: |
          cargo install --locked kani-verifier
          cargo kani setup

      - name: Build crate
        run: cargo build

      - name: Kani codegen sanity (fast compile)
        run: |
          set -euxo pipefail
          date
          # Quick compile-only pass to surface build errors fast
          # Capture full output to log, show only summary in console
          cargo kani --tests --harness verify_push_increments_len_binomial --only-codegen 2>&1 | tee kani_codegen.log | tail -n 50
          date

      - name: Run Kani – basic trait-level proof
        timeout-minutes: 30
        run: |
          set -euxo pipefail
          date
          # Capture full output to log, show only summary in console
          cargo kani --tests --harness verify_push_increments_len_binomial 2>&1 | tee kani_basic.log | tail -n 50
          date

      - name: Run Kani – implementation-specific proof (binomial decrease_key)
        timeout-minutes: 30
        run: |
          set -euxo pipefail
          date
          # Capture full output to log, show only summary in console
          cargo kani --tests --harness verify_binomial_heap_property_after_decrease_key 2>&1 | tee kani_impl.log | tail -n 50
          date

      - name: Run Kani – legacy simple proof
        timeout-minutes: 30
        run: |
          set -euxo pipefail
          date
          # Capture full output to log, show only summary in console
          cargo kani --tests --harness verify_insert_increments_len 2>&1 | tee kani_legacy.log | tail -n 50
          date

      - name: Upload Kani logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kani-logs
          path: |
            kani_codegen.log
            kani_basic.log
            kani_impl.log
            kani_legacy.log
